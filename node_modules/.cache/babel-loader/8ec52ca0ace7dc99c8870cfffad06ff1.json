{"ast":null,"code":"import _classCallCheck from \"/Users/msumaran/Documents/Proyectos/masternativos/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";\nimport _createClass from \"/Users/msumaran/Documents/Proyectos/masternativos/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass\";\nimport _inherits from \"/Users/msumaran/Documents/Proyectos/masternativos/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/inherits\";\nimport _createSuper from \"/Users/msumaran/Documents/Proyectos/masternativos/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createSuper\";\nimport FuseUtils from '@fuse/utils/FuseUtils';\nimport axios from 'axios';\nimport jwtDecode from 'jwt-decode';\n/* eslint-disable camelcase */\n\nvar JwtService = /*#__PURE__*/function (_FuseUtils$EventEmitt) {\n  _inherits(JwtService, _FuseUtils$EventEmitt);\n\n  var _super = _createSuper(JwtService);\n\n  function JwtService() {\n    var _this;\n\n    _classCallCheck(this, JwtService);\n\n    for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {\n      args[_key] = arguments[_key];\n    }\n\n    _this = _super.call.apply(_super, [this].concat(args));\n\n    _this.setInterceptors = function () {\n      axios.interceptors.response.use(function (response) {\n        return response;\n      }, function (err) {\n        return new Promise(function (resolve, reject) {\n          if (err.response.status === 401 && err.config && !err.config.__isRetryRequest) {\n            // if you ever get an unauthorized response, logout the user\n            _this.emit('onAutoLogout', 'Invalid access_token');\n\n            _this.setSession(null);\n          }\n\n          throw err;\n        });\n      });\n    };\n\n    _this.handleAuthentication = function () {\n      var access_token = _this.getAccessToken();\n\n      if (!access_token) {\n        _this.emit('onNoAccessToken');\n\n        return;\n      }\n\n      if (_this.isAuthTokenValid(access_token)) {\n        _this.setSession(access_token);\n\n        _this.emit('onAutoLogin', true);\n      } else {\n        _this.setSession(null);\n\n        _this.emit('onAutoLogout', 'access_token expired');\n      }\n    };\n\n    _this.createUser = function (data) {\n      return new Promise(function (resolve, reject) {\n        axios.post('/api/auth/register', data).then(function (response) {\n          if (response.data.user) {\n            _this.setSession(response.data.access_token);\n\n            resolve(response.data.user);\n          } else {\n            reject(response.data.error);\n          }\n        });\n      });\n    };\n\n    _this.signInWithEmailAndPassword = function (email, password) {\n      return new Promise(function (resolve, reject) {\n        axios.get('/api/auth', {\n          data: {\n            email: email,\n            password: password\n          }\n        }).then(function (response) {\n          if (response.data.user) {\n            _this.setSession(response.data.access_token);\n\n            resolve(response.data.user);\n          } else {\n            reject(response.data.error);\n          }\n        });\n      });\n    };\n\n    _this.signInWithToken = function () {\n      return new Promise(function (resolve, reject) {\n        axios.get('/api/auth/access-token', {\n          data: {\n            access_token: _this.getAccessToken()\n          }\n        }).then(function (response) {\n          if (response.data.user) {\n            _this.setSession(response.data.access_token);\n\n            resolve(response.data.user);\n          } else {\n            _this.logout();\n\n            Promise.reject(new Error('Failed to login with token.'));\n          }\n        }).catch(function (error) {\n          _this.logout();\n\n          Promise.reject(new Error('Failed to login with token.'));\n        });\n      });\n    };\n\n    _this.updateUserData = function (user) {\n      return axios.post('/api/auth/user/update', {\n        user: user\n      });\n    };\n\n    _this.setSession = function (access_token) {\n      if (access_token) {\n        localStorage.setItem('jwt_access_token', access_token);\n        axios.defaults.headers.common.Authorization = \"Bearer \".concat(access_token);\n      } else {\n        localStorage.removeItem('jwt_access_token');\n        delete axios.defaults.headers.common.Authorization;\n      }\n    };\n\n    _this.logout = function () {\n      _this.setSession(null);\n    };\n\n    _this.isAuthTokenValid = function (access_token) {\n      if (!access_token) {\n        return false;\n      }\n\n      var decoded = jwtDecode(access_token);\n      var currentTime = Date.now() / 1000;\n\n      if (decoded.exp < currentTime) {\n        console.warn('access token expired');\n        return false;\n      }\n\n      return true;\n    };\n\n    _this.getAccessToken = function () {\n      return window.localStorage.getItem('jwt_access_token');\n    };\n\n    return _this;\n  }\n\n  _createClass(JwtService, [{\n    key: \"init\",\n    value: function init() {\n      this.setInterceptors();\n      this.handleAuthentication();\n    }\n  }]);\n\n  return JwtService;\n}(FuseUtils.EventEmitter);\n\nvar instance = new JwtService();\nexport default instance;","map":{"version":3,"sources":["/Users/msumaran/Documents/Proyectos/masternativos/src/app/services/jwtService/jwtService.js"],"names":["FuseUtils","axios","jwtDecode","JwtService","setInterceptors","interceptors","response","use","err","Promise","resolve","reject","status","config","__isRetryRequest","emit","setSession","handleAuthentication","access_token","getAccessToken","isAuthTokenValid","createUser","data","post","then","user","error","signInWithEmailAndPassword","email","password","get","signInWithToken","logout","Error","catch","updateUserData","localStorage","setItem","defaults","headers","common","Authorization","removeItem","decoded","currentTime","Date","now","exp","console","warn","window","getItem","EventEmitter","instance"],"mappings":"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","sourcesContent":["import FuseUtils from '@fuse/utils/FuseUtils';\nimport axios from 'axios';\nimport jwtDecode from 'jwt-decode';\n/* eslint-disable camelcase */\n\nclass JwtService extends FuseUtils.EventEmitter {\n\tinit() {\n\t\tthis.setInterceptors();\n\t\tthis.handleAuthentication();\n\t}\n\n\tsetInterceptors = () => {\n\t\taxios.interceptors.response.use(\n\t\t\tresponse => {\n\t\t\t\treturn response;\n\t\t\t},\n\t\t\terr => {\n\t\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\t\tif (err.response.status === 401 && err.config && !err.config.__isRetryRequest) {\n\t\t\t\t\t\t// if you ever get an unauthorized response, logout the user\n\t\t\t\t\t\tthis.emit('onAutoLogout', 'Invalid access_token');\n\t\t\t\t\t\tthis.setSession(null);\n\t\t\t\t\t}\n\t\t\t\t\tthrow err;\n\t\t\t\t});\n\t\t\t}\n\t\t);\n\t};\n\n\thandleAuthentication = () => {\n\t\tconst access_token = this.getAccessToken();\n\n\t\tif (!access_token) {\n\t\t\tthis.emit('onNoAccessToken');\n\n\t\t\treturn;\n\t\t}\n\n\t\tif (this.isAuthTokenValid(access_token)) {\n\t\t\tthis.setSession(access_token);\n\t\t\tthis.emit('onAutoLogin', true);\n\t\t} else {\n\t\t\tthis.setSession(null);\n\t\t\tthis.emit('onAutoLogout', 'access_token expired');\n\t\t}\n\t};\n\n\tcreateUser = data => {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\taxios.post('/api/auth/register', data).then(response => {\n\t\t\t\tif (response.data.user) {\n\t\t\t\t\tthis.setSession(response.data.access_token);\n\t\t\t\t\tresolve(response.data.user);\n\t\t\t\t} else {\n\t\t\t\t\treject(response.data.error);\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t};\n\n\tsignInWithEmailAndPassword = (email, password) => {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\taxios\n\t\t\t\t.get('/api/auth', {\n\t\t\t\t\tdata: {\n\t\t\t\t\t\temail,\n\t\t\t\t\t\tpassword\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t\t.then(response => {\n\t\t\t\t\tif (response.data.user) {\n\t\t\t\t\t\tthis.setSession(response.data.access_token);\n\t\t\t\t\t\tresolve(response.data.user);\n\t\t\t\t\t} else {\n\t\t\t\t\t\treject(response.data.error);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t});\n\t};\n\n\tsignInWithToken = () => {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\taxios\n\t\t\t\t.get('/api/auth/access-token', {\n\t\t\t\t\tdata: {\n\t\t\t\t\t\taccess_token: this.getAccessToken()\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t\t.then(response => {\n\t\t\t\t\tif (response.data.user) {\n\t\t\t\t\t\tthis.setSession(response.data.access_token);\n\t\t\t\t\t\tresolve(response.data.user);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tthis.logout();\n\t\t\t\t\t\tPromise.reject(new Error('Failed to login with token.'));\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t\t.catch(error => {\n\t\t\t\t\tthis.logout();\n\t\t\t\t\tPromise.reject(new Error('Failed to login with token.'));\n\t\t\t\t});\n\t\t});\n\t};\n\n\tupdateUserData = user => {\n\t\treturn axios.post('/api/auth/user/update', {\n\t\t\tuser\n\t\t});\n\t};\n\n\tsetSession = access_token => {\n\t\tif (access_token) {\n\t\t\tlocalStorage.setItem('jwt_access_token', access_token);\n\t\t\taxios.defaults.headers.common.Authorization = `Bearer ${access_token}`;\n\t\t} else {\n\t\t\tlocalStorage.removeItem('jwt_access_token');\n\t\t\tdelete axios.defaults.headers.common.Authorization;\n\t\t}\n\t};\n\n\tlogout = () => {\n\t\tthis.setSession(null);\n\t};\n\n\tisAuthTokenValid = access_token => {\n\t\tif (!access_token) {\n\t\t\treturn false;\n\t\t}\n\t\tconst decoded = jwtDecode(access_token);\n\t\tconst currentTime = Date.now() / 1000;\n\t\tif (decoded.exp < currentTime) {\n\t\t\tconsole.warn('access token expired');\n\t\t\treturn false;\n\t\t}\n\n\t\treturn true;\n\t};\n\n\tgetAccessToken = () => {\n\t\treturn window.localStorage.getItem('jwt_access_token');\n\t};\n}\n\nconst instance = new JwtService();\n\nexport default instance;\n"]},"metadata":{},"sourceType":"module"}